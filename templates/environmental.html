{% extends "base.html" %}

{% block title %}Environmental Data - IntelliHome{% endblock %}

{% block content %}
<h1 class="page-title">ğŸŒ¡ï¸ Environmental Data</h1>

<div class="card">
    <h2>ğŸ“… Select Date and Sensor</h2>
    <div class="dashboard-grid">
        <div class="form-group">
            <label for="dateSelect">Select Date:</label>
            <input type="date" id="dateSelect" class="form-control" value="{{ today }}">
        </div>

        <div class="form-group">
            <label for="sensorSelect">Select Sensor:</label>
            <select id="sensorSelect" class="form-control">
                <option value="temperature">Temperature (Â°C)</option>
                <option value="humidity">Humidity (%)</option>
                <option value="pressure">Pressure (hPa)</option>
            </select>
        </div>
    </div>

    <button onclick="loadData()" class="btn btn-primary">Load Data</button>
</div>

<div class="card">
    <h2>ğŸ“Š Data Visualization</h2>
    <canvas id="envChart"></canvas>
</div>

<div class="card">
    <h2>ğŸ“‹ Data Table</h2>
    <div id="dataTableContainer">
        <p style="color: #666;">Select a date and sensor, then click "Load Data" to view results.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('dateSelect').value = '{{ today }}';

    function convertUTCToEastern(utcDateString) {
        const utcDate = new Date(utcDateString);
        return new Date(utcDate.toLocaleString('en-US', { timeZone: 'America/New_York' }));
    }

    function loadData() {
        const date = document.getElementById('dateSelect'). value;
        const sensor = document.getElementById('sensorSelect').value;

        if (!date) {
            alert('Please select a date');
            return;
        }

        fetch('/api/environmental/data', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON. stringify({date: date, sensor: sensor})
        })
        .then(response => response.json())
        . then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }

            updateChart(data);
            updateTable(data);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load data');
        });
    }

    function updateChart(data) {
        const ctx = document. getElementById('envChart').getContext('2d');

        if (window.chartInstance) {
            window.chartInstance.destroy();
        }

        const sensorLabels = {
            temperature: 'Temperature (Â°C)',
            humidity: 'Humidity (%)',
            pressure: 'Pressure (hPa)'
        };

        const colors = {
            temperature: 'rgb(255, 99, 132)',
            humidity: 'rgb(54, 162, 235)',
            pressure: 'rgb(75, 192, 192)'
        };

        const easternTimestamps = data.timestamps.map(t => {
            const easternDate = convertUTCToEastern(t);
            const hours = easternDate.getHours();
            const minutes = easternDate.getMinutes(). toString().padStart(2, '0');
            const ampm = hours >= 12 ?  'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            return `${displayHours}:${minutes} ${ampm}`;
        });

        window.chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: easternTimestamps,
                datasets: [{
                    label: sensorLabels[data.sensor],
                    data: data.values,
                    borderColor: colors[data.sensor],
                    backgroundColor: colors[data.sensor]. replace('rgb', 'rgba'). replace(')', ', 0.1)'),
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time (Eastern)'
                        }
                    }
                }
            }
        });
    }

    function updateTable(data) {
        const container = document.getElementById('dataTableContainer');

        if (data.values.length === 0) {
            container.innerHTML = '<p style="color: #666;">No data found for the selected date. </p>';
            return;
        }

        const sensorLabels = {
            temperature: 'Temperature (Â°C)',
            humidity: 'Humidity (%)',
            pressure: 'Pressure (hPa)'
        };

        let html = '<table><thead><tr><th>Time (Eastern)</th><th>' + sensorLabels[data. sensor] + '</th></tr></thead><tbody>';

        for (let i = 0; i < data.timestamps.length; i++) {
            const easternDate = convertUTCToEastern(data.timestamps[i]);
            const month = easternDate.getMonth() + 1;
            const day = easternDate.getDate();
            const year = easternDate.getFullYear();
            const hours = easternDate.getHours();
            const minutes = easternDate.getMinutes().toString().padStart(2, '0');
            const seconds = easternDate.getSeconds(). toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;

            const timeString = `${month}/${day}/${year}, ${displayHours}:${minutes}:${seconds} ${ampm}`;
            html += `<tr><td>${timeString}</td><td>${data. values[i]}</td></tr>`;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }
</script>
{% endblock %}